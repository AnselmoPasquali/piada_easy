<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PDF Viewer</title>

  <style>
    html, body { height: 100%; margin: 0; background: #111; overflow: hidden; }
    #wrap { position: fixed; inset: 0; display: flex; flex-direction: column; }

    #bar {
      height: 48px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 10px;
      background: rgba(0,0,0,.65);
      color: #fff;
      font: 14px system-ui, -apple-system, Segoe UI, Roboto, Arial;
      user-select: none;
    }
    #bar button{
      height: 34px; min-width: 38px;
      border: 0; border-radius: 10px;
      background: rgba(255,255,255,.12);
      color: #fff; font-size: 18px;
    }
    #bar button:active { transform: scale(.98); }
    #label { opacity: .9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    #viewer {
      flex: 1;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      padding: 12px 0;
      display: grid;
      place-items: center;
    }

    .page {
      margin: 10px 0;
      background: #fff;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    #msg {
      color: #fff;
      font: 14px system-ui, -apple-system, Segoe UI, Roboto, Arial;
      opacity: .85;
      padding: 14px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div id="wrap">
    <div id="bar">
      <button id="minus" aria-label="Zoom out">−</button>
      <button id="plus" aria-label="Zoom in">+</button>
      <button id="fit" aria-label="Adatta pagina">⤢</button>
      <span id="label"></span>
    </div>

    <div id="viewer">
      <div id="msg">Caricamento…</div>
    </div>
  </div>

  <!-- PDF.js da CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>
  <script>
    const viewer = document.getElementById("viewer");
    const label  = document.getElementById("label");
    const msg    = document.getElementById("msg");

    const params = new URLSearchParams(location.search);
    const file = params.get("file") || "pdf-mattina.pdf";

    let userZoom = 1.0;
    let baseZoom = 1.0;
    let pdfDoc = null;

    function setMessage(text) {
      msg.textContent = text;
      msg.style.display = "block";
    }
    function hideMessage() {
      msg.style.display = "none";
    }
    function clearPages() {
      // lascia msg, cancella solo le canvas
      viewer.querySelectorAll("canvas.page").forEach(c => c.remove());
    }

    function computeBaseZoom(pageW, pageH, containerW, containerH, singlePage) {
      const wScale = containerW / pageW;
      const hScale = containerH / pageH;
      return singlePage ? Math.min(wScale, hScale) : wScale; // 1 pagina: fit-to-page, multi: fit-to-width
    }

    async function renderAllPages() {
      if (!pdfDoc) return;

      clearPages();

      const containerW = Math.max(320, viewer.clientWidth - 24);
      const containerH = Math.max(320, viewer.clientHeight - 24);
      const singlePage = pdfDoc.numPages === 1;

      const p1 = await pdfDoc.getPage(1);
      const vp1 = p1.getViewport({ scale: 1 });

      baseZoom = computeBaseZoom(vp1.width, vp1.height, containerW, containerH, singlePage);
      const finalScale = baseZoom * userZoom;

      for (let i = 1; i <= pdfDoc.numPages; i++) {
        const page = await pdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: finalScale });

        const canvas = document.createElement("canvas");
        canvas.className = "page";

        const dpr = window.devicePixelRatio || 1;
        canvas.width  = Math.floor(viewport.width * dpr);
        canvas.height = Math.floor(viewport.height * dpr);
        canvas.style.width  = Math.floor(viewport.width) + "px";
        canvas.style.height = Math.floor(viewport.height) + "px";

        const ctx = canvas.getContext("2d");
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        viewer.appendChild(canvas);
        await page.render({ canvasContext: ctx, viewport }).promise;
      }

      label.textContent = `${file} — Zoom ${Math.round(userZoom * 100)}%`;
      hideMessage();
    }

    async function loadPdf() {
      setMessage("Caricamento PDF…");

      // cache-bust
      const url = `${file}?v=${Date.now()}`;

      // FIX IMPORTANTE: disabilita worker (evita blocchi cross-origin su Pages)
      pdfDoc = await pdfjsLib.getDocument({
        url,
        disableWorker: true
      }).promise;

      userZoom = 1.0;
      await renderAllPages();
    }

    document.getElementById("plus").addEventListener("click", async () => {
      userZoom = Math.min(4, userZoom * 1.2);
      await renderAllPages();
    });

    document.getElementById("minus").addEventListener("click", async () => {
      userZoom = Math.max(0.25, userZoom / 1.2);
      await renderAllPages();
    });

    document.getElementById("fit").addEventListener("click", async () => {
      userZoom = 1.0;
      await renderAllPages();
      viewer.scrollTo({ top: 0, behavior: "smooth" });
    });

    let t = null;
    window.addEventListener("resize", () => {
      clearTimeout(t);
      t = setTimeout(() => { renderAllPages(); }, 200);
    });

    loadPdf().catch(err => {
      label.textContent = file;
      setMessage("Errore: impossibile caricare il PDF.\n\n" + (err?.message || String(err)));
    });
  </script>
</body>
</html>
